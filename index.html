<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê·¸ëœë“œì²´ì´ìŠ¤ ìˆ™ì œí‘œ</title>
    <style>
        /* === 1. ë‹¤í¬/ë¼ì´íŠ¸ ëª¨ë“œ ë³€ìˆ˜ ì„¤ì • (ë¬´ì±„ìƒ‰ ê³„ì—´) === */
        :root {
            /* Light Mode Default (Monochromatic) */
            --bg-main: #f0f0f0;
            --bg-container: #ffffff;
            --bg-item: #e8e8e8;
            --text-color: #333333;
            --title-color: #333333; 
            --accent-color: #cc0000; /* Red for general important elements */
            --shadow-color: rgba(0, 0, 0, 0.15);
            --border-color: #ccc;
            --shared-tag: #666666; 
            --drag-bg: #ffcccc;
            --favorite-bg: #f8f8ff; /* ì—°í•œ íŒŒë‘ ê³„ì—´ */
            --favorite-border: #d3d3d3;
            --sidebar-bg: #eeeeee; /* ì‚¬ì´ë“œë°” ë°°ê²½ */
            --progress-bar-bg: #d9d9d9;
            --progress-done: #4CAF50; /* Green */
        }

        /* Dark Mode (Class ì ìš© ì‹œ) (Monochromatic) */
        .dark-mode {
            --bg-main: #1c1c1c;
            --bg-container: #252525;
            --bg-item: #333333;
            --text-color: #f0f0f0;
            --title-color: #ffffff; 
            --accent-color: #ff3333; 
            --shadow-color: rgba(255, 255, 255, 0.1);
            --border-color: #444;
            --shared-tag: #999999; 
            --drag-bg: #550000;
            --favorite-bg: #111111; /* ë§¤ìš° ì–´ë‘ìš´ íšŒìƒ‰ */
            --favorite-border: #333333;
            --sidebar-bg: #222222;
            --progress-bar-bg: #444444;
            --progress-done: #66BB6A;
        }

        /* === 2. ê¸°ë³¸ ìŠ¤íƒ€ì¼ === */
        body { 
            background-color: var(--bg-main); 
            color: var(--text-color); 
            font-family: 'Malgun Gothic', sans-serif; 
            display: flex; 
            justify-content: center; 
            padding: 20px; 
            margin: 0; 
            transition: background-color 0.3s, color 0.3s;
        }
        .container { 
            width: 100%; 
            max-width: 1100px; 
            background-color: var(--bg-container); 
            padding: 25px; 
            border-radius: 15px; 
            box-shadow: 0 10px 30px var(--shadow-color); 
        }
        
        /* í—¤ë” */
        h1 { text-align: center; color: var(--title-color); margin-bottom: 5px; font-size: 2.5em; transition: color 0.3s; }
        .info-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; font-size: 0.9em; }
        .reset-info { color: var(--text-color); opacity: 0.7; }
        #current-time-display { font-weight: bold; color: var(--text-color); }

        /* ìºë¦­í„° ì„ íƒ ì„¹ì…˜ ì œëª© */
        .char-select-title-group { text-align: center; margin-top: 35px; margin-bottom: 10px; border-bottom: 2px solid var(--border-color); padding-bottom: 8px; }
        .char-select-title-group h2 { border-bottom: none; padding-bottom: 0; margin-top: 0; font-size: 1.5em; color: var(--text-color); }
        .char-select-info { display: block; color: var(--text-color); opacity: 0.7; font-size: 0.9em; margin-top: 5px; margin-bottom: 15px; }
        h3 { color: var(--text-color); margin-top: 15px; margin-bottom: 10px; font-size: 1.1em; }
        
        /* === 3. í•„í„° ë° í†µê³„ ì˜ì—­ === */
        #filter-stats-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }
        #account-stats {
            font-size: 1em;
            font-weight: bold;
            color: var(--text-color);
        }
        
        /* í•„í„° í† ê¸€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #filter-toggle-btn {
            background-color: var(--bg-item);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        #filter-toggle-btn.active {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        /* === 4. ëª¨ë“  ìºë¦­í„° ì„ íƒ ì˜ì—­ (ìƒë‹¨) === */
        #character-selector { 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 6px; 
            margin-bottom: 25px; 
        }
        
        /* === 5. ìˆ™ì œ ëª©ë¡ ë° ì‚¬ì´ë“œë°” ì»¨í…Œì´ë„ˆ === */
        #main-content-area {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        /* ì¦ê²¨ì°¾ê¸° ì‚¬ì´ë“œë°” */
        #favorite-sidebar {
            width: 200px;
            min-width: 180px;
            background-color: var(--sidebar-bg);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 10px var(--shadow-color);
            align-self: flex-start;
            z-index: 10;
        }
        
        #favorite-sidebar h3 { margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; font-size: 1.1em; }
        #favorite-list { display: flex; flex-direction: column; gap: 10px; min-height: 100px; }
        .favorite-list-placeholder { color: var(--text-color); opacity: 0.5; font-style: italic; font-size: 0.9em; text-align: center; padding: 10px; }
        
        /* ì¼ì¼/ì£¼ê°„ ìˆ™ì œ ì»¨í…Œì´ë„ˆ (ì‚¬ì´ë“œë°” ì˜†ì˜ ë‚˜ë¨¸ì§€ ê³µê°„) */
        #task-view-container { 
            flex: 1; 
            display: flex; /* ë‚´ë¶€ì˜ ì¼ì¼/ì£¼ê°„ ì»¬ëŸ¼ì„ ë‚˜ë€íˆ ë°°ì¹˜ */
            gap: 30px; 
        }
        
        /* ì¼ì¼/ì£¼ê°„ ìˆ™ì œ ì»¬ëŸ¼ Wrapper */
        .task-column-wrapper { 
            flex: 1; 
            background-color: var(--bg-main); 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: inset 0 0 10px var(--shadow-color); 
        }

        /* === 6. ìºë¦­í„° ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ === */
        .char-btn { 
            background-color: var(--bg-item); 
            color: var(--text-color); 
            border: 1px solid var(--border-color); 
            padding: 8px 12px; 
            border-radius: 20px; 
            cursor: grab; 
            font-size: 0.85em; 
            transition: all 0.2s ease-in-out; 
            user-select: none;
            position: relative; 
        }
        .char-btn.dragging { opacity: 0.5; box-shadow: 0 5px 15px var(--shadow-color); }
        .char-btn.drag-over { border: 2px dashed var(--accent-color); background-color: var(--drag-bg); }
        
        /* ìºë¦­í„° ë²„íŠ¼ ë‚´ í”„ë¡œê·¸ë ˆìŠ¤ ë°” */
        .progress-bar-container {
            height: 3px;
            width: 100%;
            background-color: var(--progress-bar-bg);
            border-radius: 2px;
            margin-top: 5px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background-color: var(--progress-done);
            transition: width 0.3s;
        }
        
        /* === 7. ìˆ™ì œ ì•„ì´í…œ ë° í†µê³„ ì˜ì—­ === */
        .task-item { display: flex; align-items: center; background-color: var(--bg-item); margin-bottom: 10px; padding: 12px; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 1em; justify-content: flex-start; }
        .task-item.done { opacity: 0.6; }
        
        /* ë ˆì´ë¸” ê·¸ë£¹ */
        .task-label-group { 
            display: flex; 
            align-items: center; 
            margin-left: 10px; 
            flex-wrap: wrap; 
        }
        
        /* ìŠ¤í‹°ì»¤ ìŠ¤íƒ€ì¼ */
        .task-tag {
            font-size: 0.7em;
            font-weight: bold;
            color: white;
            background-color: var(--shared-tag); 
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
            white-space: nowrap;
        }
        
        /* ìš”ì¼ ìŠ¤í‹°ì»¤ ì „ìš© ìƒ‰ìƒ */
        .task-tag.day {
            background-color: #9c27b0; 
        }

        /* ìºë¦­í„°ë³„ ì™„ë£Œìœ¨ í‘œì‹œ ì˜ì—­ (ìƒˆë¡œìš´ ìœ„ì¹˜ì— ë§ê²Œ ìŠ¤íƒ€ì¼ ì¡°ì •) */
        #daily-stats-display, #weekly-stats-display {
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 15px;
            margin-top: -10px; /* ì œëª©ê³¼ì˜ ê°„ê²© ì¡°ì • */
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        .stat-bar-container {
            flex-grow: 1;
            height: 10px;
            background-color: var(--progress-bar-bg);
            border-radius: 5px;
            margin-left: 10px;
            overflow: hidden;
        }
        .stat-bar {
            height: 100%;
            background-color: var(--progress-done);
            transition: width 0.3s;
        }


        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 950px) {
            #main-content-area { flex-direction: column; }
            #favorite-sidebar { width: 100%; min-width: auto; }
            #favorite-list { flex-direction: row; flex-wrap: wrap; justify-content: center; }
            #task-view-container { flex-direction: column; }
            .container { padding: 15px; }
            #theme-toggle { top: 15px; right: 15px; padding: 6px 10px; font-size: 0.8em; }
            .info-header { flex-direction: column; align-items: flex-start; gap: 5px; }
            #filter-stats-container { flex-direction: column; align-items: flex-start; gap: 10px; }
        }
    </style>
</head>
<body class="dark-mode"> 

<div class="container">
    <button id="theme-toggle" onclick="toggleTheme()"></button>
    <h1>ê·¸ëœë“œì²´ì´ìŠ¤ ìˆ™ì œí‘œ</h1>
    
    <div class="info-header">
        <div class="reset-info">ì¼ì¼: ë§¤ì¼ 15:00 ì´ˆê¸°í™” | ì£¼ê°„: ìˆ˜ìš”ì¼ 15:00 ì´ˆê¸°í™” (KST)</div>
        <div id="current-time-display"></div>
    </div>


    <div class="char-select-title-group">
        <h2>ëª¨ë“  ìºë¦­í„°</h2>
        <span class="char-select-info">ìºë¦­í„°ë¥¼ ì¦ê²¨ì°¾ê¸° ì‚¬ì´ë“œë°”ë¡œ ë“œë˜ê·¸í•˜ê±°ë‚˜, ì•„ë˜ì—ì„œ ìˆœì„œë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
    </div>
    
    <div id="filter-stats-container">
        <div id="account-stats"></div>
        <button id="filter-toggle-btn" onclick="toggleFilter()">ğŸ” ìˆ™ì œ ë‚¨ì€ ìºë¦­í„°ë§Œ ë³´ê¸°</button>
    </div>
    
    <div id="character-selector" ondragover="handleDragOver(event)" ondrop="handleDrop(event)" ondragleave="handleDragLeave(event)"></div>
    
    <h2 id="current-char-name"></h2>
    
    <div id="main-content-area">
        <div id="favorite-sidebar" 
             ondragover="handleDragOver(event)" 
             ondrop="handleDropToFavorite(event)" 
             ondragleave="handleDragLeave(event)">
            <h3>â­ï¸ ì¦ê²¨ì°¾ê¸°</h3>
            <div id="favorite-list">
                <span class="favorite-list-placeholder">ìºë¦­í„°ë¥¼ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ì„¸ìš”.</span>
            </div>
        </div>

        <div id="task-view-container">
            
            <div class="task-column-wrapper">
                <h3>ğŸ“… ì¼ì¼ ìˆ™ì œ</h3> <div id="daily-stats-display"></div> 
                <div id="daily-list"></div>
            </div>

            <div class="task-column-wrapper">
                <h3>âš”ï¸ ì£¼ê°„ ìˆ™ì œ</h3> <div id="weekly-stats-display"></div>
                <div id="weekly-list"></div>
            </div>
        </div>
    </div>

    <div class="footer">
        ë°ì´í„°ëŠ” ë¸Œë¼ìš°ì €ì— ìë™ ì €ì¥ë©ë‹ˆë‹¤. (ê¸°ê¸° ê°„ ì—°ë™ X)
    </div>
</div>

<script>
    // === 1. ê¸°ë³¸ ë°ì´í„° ì„¤ì • ===
    
    const CHAR_COLORS = {
        'ì—˜ë¦¬ì‹œìŠ¤': '#ff0000', 'ë¦¬ë¥´': '#9acd32', 'ì•„ë¥´ë©”': '#a020f0', 'ë¼ìŠ¤': '#87ceeb',
        'ë¼ì´ì–¸': '#008000', 'ë¡œë‚œ': '#4169e1', 'ì—ì´ë¯¸': '#ff69b4', 'ì§„': '#ff4500', 
        'ì§€í¬í•˜íŠ¸': '#000000', 'ë§ˆë¦¬': '#0000ff', 'ë””ì˜¤': '#800080', 'ì œë¡œ': '#3cb371', 
        'ë ˆì´': '#8a2be2', 'ë£¨í¼ìŠ¤': '#b22222', 'ë² ì´ê°€ìŠ¤': '#483d8b', 'ë¦°': '#808080', 
        'ì•„ì‹ ': '#00bfff', 'ë¼ì„': '#32cd32', 'ì—ë¸': '#4169e1', 'ë°ì¹´ë„¤': '#00ffff', 
        'ì•„ì´': '#afeeee', 'ì¹¼ë¦¬ì•„': '#c71585', 'ìš°ë…¸': '#008b8b', 'ì´ë¦¬ìŠ¤': '#add8e6'
    };

    let CHARACTER_NAMES = [
        'ì—˜ë¦¬ì‹œìŠ¤', 'ë¦¬ë¥´', 'ì•„ë¥´ë©”', 'ë¼ìŠ¤', 'ë¼ì´ì–¸', 'ë¡œë‚œ', 'ì—ì´ë¯¸', 'ì§„', 'ì§€í¬í•˜íŠ¸', 'ë§ˆë¦¬', 
        'ë””ì˜¤', 'ì œë¡œ', 'ë ˆì´', 'ë£¨í¼ìŠ¤', 'ë² ì´ê°€ìŠ¤', 'ë¦°', 'ì•„ì‹ ', 'ë¼ì„', 'ì—ë¸', 'ë°ì¹´ë„¤', 
        'ì•„ì´', 'ì¹¼ë¦¬ì•„', 'ìš°ë…¸', 'ì´ë¦¬ìŠ¤'
    ];
    
    // ë˜ì „ ë°ì´í„°
    const DUNGEON_DATA = {
        daily: [
            { id: 'berkas', name: 'ë² ë¥´ì¹´ìŠ¤ì˜ ìš”ìƒˆ', max: 1, shared: false },
            { id: 'tower', name: 'ì†Œë©¸ì˜ íƒ‘', max: 3, shared: false },
            { id: 'tero', name: 'ì´ì„¸ê³„: í…Œë¡œì¹´ ê³µì„±ì „', max: 1, shared: false },
            { id: 'temple', name: 'ì´ì„¸ê³„: ì‹œê°„ì˜ ì‚¬ì›', max: 1, shared: false },
            { id: 'kounat', name: 'ì´ì„¸ê³„: ì½”ìš°ë‚˜íŠ¸ ëŒ€í­ë°œ', max: 1, shared: false },
            { id: 'corridor', name: 'ë¬´í•œíšŒë‘', max: 3, type: 'daily', shared: true }
        ],
        weekly: [
            { id: 'judge', name: 'ì‹¬íŒì˜ ë•…', max: 3, shared: false },
            { id: 'abyss', name: 'ì‹¬ì—°ì˜ ê¸¸', max: 1, shared: false },
            { id: 'void_mon', name: 'ê³µí—ˆ ì¹¨ê³µ', max: 1, shared: false, sub: 'ì›”' }, 
            { id: 'void_wed', name: 'ê³µí—ˆ ì ì‹', max: 1, shared: false, sub: 'ìˆ˜' }, 
            { id: 'void_fri', name: 'ê³µí—ˆ ì•…ëª½', max: 1, shared: false, sub: 'ê¸ˆ' }, 
            { id: 'w_furnace', name: 'ì§€ì˜¥ì˜ ìš©ê´‘ë¡œ', max: 3, shared: false },
            { id: 'w_sanctum', name: 'íŒŒë©¸ì˜ ì„±ì†Œ', max: 3, shared: false },
            { id: 'w_laby', name: 'í™˜ì˜ì˜ ë¯¸ê¶', max: 5, shared: false }
        ]
    };
    
    let characters = []; 
    let currentChrId = null; 
    let draggedElement = null; 
    let FAVORITE_NAMES = [];
    let isFilterActive = false; 

    // === 2. ë³´ì¡° í•¨ìˆ˜ ===
    
    function getTextColor(hexColor) { 
        const r = parseInt(hexColor.substring(1, 3), 16);
        const g = parseInt(hexColor.substring(3, 5), 16);
        const b = parseInt(hexColor.substring(5, 7), 16);
        const luminance = (0.2126 * r + 0.7152 * g + 0.0722 * b) / 255;
        return luminance > 0.5 ? '#000000' : '#ffffff';
    }

    // === 3. ë°ì´í„° ë¡œì§ (ì´ˆê¸°í™” ë° ë¡œë“œ) ===

    const getTaskMaxCount = (taskId) => {
        let item = DUNGEON_DATA.daily.find(d => d.id === taskId);
        if (!item) item = DUNGEON_DATA.weekly.find(d => d.id === taskId);
        return item ? item.max : 1;
    };

    const getAccountSharedTaskStatus = (id) => {
        const saved = localStorage.getItem(`shared_${id}`);
        return saved ? JSON.parse(saved) : { completed: 0, max: getTaskMaxCount(id) };
    };

    const setAccountSharedTaskStatus = (id, status) => {
        localStorage.setItem(`shared_${id}`, JSON.stringify(status));
    };

    const generateInitialTasks = (type) => {
        const tasks = {};
        DUNGEON_DATA[type].filter(d => !d.shared).forEach(d => {
            tasks[d.id] = { completed: 0, max: d.max };
        });
        return tasks;
    };

    // ìºë¦­í„°ë³„ ì¼ì¼/ì£¼ê°„ ìˆ™ì œ ìƒíƒœ ê³„ì‚° (í†µê³„ ê³„ì‚° í•¨ìˆ˜)
    function calculateCharStats(char, type) {
        let totalCount = 0;
        let completedCount = 0;
        
        DUNGEON_DATA[type].filter(d => !d.shared).forEach(d => {
            // ì•ˆì „í•œ ì ‘ê·¼ì„ ìœ„í•´ ì´ˆê¸°í™”ë˜ì§€ ì•Šì€ taskëŠ” 0ìœ¼ë¡œ ì²˜ë¦¬ (ë°©ì–´ ì½”ë“œ)
            const status = char[`${type}Tasks`][d.id] || { completed: 0, max: d.max }; 
            totalCount += status.max;
            completedCount += status.completed;
        });
        
        const percentage = totalCount > 0 ? Math.floor((completedCount / totalCount) * 100) : 100;
        
        return { totalCount, completedCount, percentage };
    }

    function initializeData() {
        const savedOrder = localStorage.getItem('characterOrder');
        if (savedOrder) {
            const savedNames = JSON.parse(savedOrder);
            const newNames = CHARACTER_NAMES.filter(name => !savedNames.includes(name));
            CHARACTER_NAMES = [...savedNames, ...newNames];
        }
        
        const savedFavorites = localStorage.getItem('favoriteCharacters');
        FAVORITE_NAMES = savedFavorites ? JSON.parse(savedFavorites).filter(name => CHARACTER_NAMES.includes(name)) : [];
        isFilterActive = localStorage.getItem('isFilterActive') === 'true'; 

        const savedData = localStorage.getItem('gc_characters');
        const lastReset = localStorage.getItem('lastResetTime');

        const existingIds = savedData ? JSON.parse(savedData).map(c => c.id) : [];
        let nextId = existingIds.length > 0 ? Math.max(...existingIds) + 1 : 1;
        const charMap = new Map(savedData ? JSON.parse(savedData).map(c => [c.name, c]) : []);

        characters = CHARACTER_NAMES.map(name => {
            let char = charMap.get(name);
            
            if (!char) {
                char = {
                    id: nextId++,
                    name: name,
                    dailyTasks: generateInitialTasks('daily'),
                    weeklyTasks: generateInitialTasks('weekly')
                };
            }
            
            const updatedChar = { ...char };
            
            // í•„ìˆ˜ ì´ˆê¸°í™”
            updatedChar.dailyTasks = updatedChar.dailyTasks || generateInitialTasks('daily');
            updatedChar.weeklyTasks = updatedChar.weeklyTasks || generateInitialTasks('weekly');
            
            return updatedChar;
        });
        
        checkAndApplyReset(characters, lastReset);
        
        // **ìˆ˜ì •: í†µê³„ ê³„ì‚°ì„ ë Œë”ë§ ì „ì— ìˆ˜í–‰í•˜ì—¬ ë°ì´í„° ì˜¤ë¥˜ ë°©ì§€**
        characters.forEach(char => {
            const dailyStats = calculateCharStats(char, 'daily');
            const weeklyStats = calculateCharStats(char, 'weekly');
            char.dailyStats = dailyStats;
            char.weeklyStats = weeklyStats;
            char.hasIncompleteDaily = dailyStats.totalCount > dailyStats.completedCount;
            char.hasIncompleteWeekly = weeklyStats.totalCount > weeklyStats.completedCount;
        });
        // ----------------------------------------------------

        localStorage.setItem('gc_characters', JSON.stringify(characters));
        currentChrId = localStorage.getItem('currentChrId') || (characters.length > 0 ? characters[0].id : null);
        
        // ë Œë”ë§ í•¨ìˆ˜ í˜¸ì¶œì€ render() ë‚´ì—ì„œ í†µí•© ê´€ë¦¬
    }
    
    function checkAndApplyReset(currentChars, lastResetTime) { 
        // ê¸°ì¡´ê³¼ ë™ì¼í•œ ì´ˆê¸°í™” ë¡œì§
        const now = new Date();
        const dailyResetHour = 15;
        const weeklyResetDay = 3; // ìˆ˜ìš”ì¼ (0:ì¼ìš”ì¼, 1:ì›”ìš”ì¼, ..., 3:ìˆ˜ìš”ì¼)

        const kstNow = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Seoul" }));
        
        let shouldResetDaily = false;
        let shouldResetWeekly = false;

        if (lastResetTime) {
            const lastReset = new Date(lastResetTime);
            const lastResetKST = new Date(lastReset.toLocaleString("en-US", { timeZone: "Asia/Seoul" }));

            // ì¼ì¼ ì´ˆê¸°í™” í™•ì¸
            let nextDailyReset = new Date(lastResetKST);
            nextDailyReset.setHours(dailyResetHour, 0, 0, 0);

            if (kstNow.getTime() >= nextDailyReset.getTime()) {
                // ì˜¤ëŠ˜ ì´ˆê¸°í™” ì‹œê°„ì„ ë„˜ê²¼ë‹¤ë©´
                if (kstNow.getDate() > nextDailyReset.getDate() || kstNow.getMonth() > nextDailyReset.getMonth() || kstNow.getFullYear() > nextDailyReset.getFullYear()) {
                    shouldResetDaily = true;
                } else if (kstNow.getHours() >= dailyResetHour && lastResetKST.getHours() < dailyResetHour) {
                    // ê°™ì€ ë‚ ì´ë¼ë„ ë¦¬ì…‹ ì‹œê°„ì„ í†µê³¼í–ˆë‹¤ë©´
                    shouldResetDaily = true;
                }
            }

            // ì£¼ê°„ ì´ˆê¸°í™” í™•ì¸
            let checkTime = new Date(lastResetKST);
            let nextCheckReset = new Date(lastResetKST);
            
            while(checkTime.getTime() < kstNow.getTime()) {
                // ë‹¤ìŒ ìˆ˜ìš”ì¼ 15ì‹œë¥¼ ì°¾ìŒ
                nextCheckReset.setDate(nextCheckReset.getDate() + (weeklyResetDay - nextCheckReset.getDay() + 7) % 7);
                nextCheckReset.setHours(dailyResetHour, 0, 0, 0);

                // í˜„ì¬ checkTimeê³¼ kstNow ì‚¬ì´ì— ë¦¬ì…‹ ì‹œê°„ì´ ìˆë‹¤ë©´
                if(nextCheckReset.getTime() > checkTime.getTime() && nextCheckReset.getTime() <= kstNow.getTime()) {
                    shouldResetWeekly = true;
                    // ë‹¤ìŒ ë¦¬ì…‹ ì£¼ê¸°ë¥¼ ìœ„í•´ checkTimeì„ 1ì´ˆ í›„ë¡œ ì´ë™
                    checkTime = new Date(nextCheckReset.getTime() + 1000); 
                } else {
                    break;
                }
            }


        } else {
            // ì²« ë¡œë“œ ì‹œ í˜„ì¬ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ë¦¬ì…‹ ì—¬ë¶€ ê²°ì • (ëŒ€ë¶€ë¶„ ë¦¬ì…‹ í•„ìš”)
            shouldResetDaily = true;
            shouldResetWeekly = true;
        }


        if (shouldResetDaily) {
            currentChars.forEach(char => {
                char.dailyTasks = generateInitialTasks('daily');
            });
            // ê³„ì • ê³µìœ  ì¼ì¼ ìˆ™ì œ ì´ˆê¸°í™”
            setAccountSharedTaskStatus('corridor', { completed: 0, max: getTaskMaxCount('corridor') });
        }

        if (shouldResetWeekly) {
            currentChars.forEach(char => {
                char.weeklyTasks = generateInitialTasks('weekly');
            });
        }
        
        if (shouldResetDaily || shouldResetWeekly) {
            localStorage.setItem('lastResetTime', kstNow.toISOString());
            // console.log('ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. Daily:', shouldResetDaily, 'Weekly:', shouldResetWeekly);
        }
    }

    // === 4. í†µê³„ ë° í•„í„° ë¡œì§ ===

    // ê³„ì • ì „ì²´ í†µê³„ ì—…ë°ì´íŠ¸
    function updateAccountStats() {
        let totalDaily = 0;
        let doneDaily = 0;
        let totalWeekly = 0;
        let doneWeekly = 0;

        characters.forEach(char => {
            totalDaily += char.dailyStats.totalCount;
            doneDaily += char.dailyStats.completedCount;
            totalWeekly += char.weeklyStats.totalCount;
            doneWeekly += char.weeklyStats.completedCount;
        });

        const sharedDaily = DUNGEON_DATA.daily.find(d => d.shared && d.id === 'corridor');
        if (sharedDaily) {
            const sharedStatus = getAccountSharedTaskStatus(sharedDaily.id);
            totalDaily += sharedStatus.max;
            doneDaily += sharedStatus.completed;
        }

        const dailyPercent = totalDaily > 0 ? ((doneDaily / totalDaily) * 100).toFixed(1) : 100;
        const weeklyPercent = totalWeekly > 0 ? ((doneWeekly / totalWeekly) * 100).toFixed(1) : 100;

        const statsText = `
            ì¼ì¼ ìˆ™ì œ: ${doneDaily}/${totalDaily} (${dailyPercent}%) | 
            ì£¼ê°„ ìˆ™ì œ: ${doneWeekly}/${totalWeekly} (${weeklyPercent}%)
        `;
        document.getElementById('account-stats').innerText = statsText;
    }

    // í•„í„° í† ê¸€
    function toggleFilter() {
        isFilterActive = !isFilterActive;
        localStorage.setItem('isFilterActive', isFilterActive);
        render();
    }
    
    // í•„í„° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateFilterButton() {
        const button = document.getElementById('filter-toggle-btn');
        if (isFilterActive) {
            button.classList.add('active');
        } else {
            button.classList.remove('active');
        }
    }
    
    // === 5. DND ë° í•¸ë“¤ëŸ¬ ===
    function handleDragStart(e) { 
        draggedElement = e.target;
        const charName = draggedElement.getAttribute('data-char-name');
        e.dataTransfer.setData('text/plain', charName);
        
        const isFavoriteDrag = draggedElement.closest('#favorite-list') !== null;
        e.dataTransfer.setData('application/json', isFavoriteDrag ? 'favorite' : 'all');
        
        e.dataTransfer.effectAllowed = 'move';
        e.target.classList.add('dragging');
    }

    function handleDragOver(e) { 
        e.preventDefault(); 
        e.dataTransfer.dropEffect = 'move';
        
        document.querySelectorAll('.char-btn.drag-over').forEach(btn => btn.classList.remove('drag-over'));
        document.querySelector('#favorite-sidebar').classList.remove('drag-over');
        
        const target = e.target.closest('.char-btn') || e.target.closest('#favorite-sidebar') || e.target.closest('#character-selector');
        
        if (target) {
            const isFavoriteDrag = e.dataTransfer.getData('application/json') === 'favorite';
            const isAllCharDrag = e.dataTransfer.getData('application/json') === 'all';
            
            if (target.id === 'favorite-sidebar' && isAllCharDrag) {
                target.classList.add('drag-over');
            } else if (target.classList.contains('char-btn') && target !== draggedElement) {
                if (target.closest('#favorite-list') && isFavoriteDrag) {
                    target.classList.add('drag-over');
                } else if (target.closest('#character-selector') && isAllCharDrag) {
                    target.classList.add('drag-over');
                }
            } else if (target.id === 'character-selector' && isFavoriteDrag) {
                target.classList.add('drag-over');
            }
        }
    }
    
    function handleDragLeave(e) { 
        if (e.target.classList.contains('char-btn')) {
            e.target.classList.remove('drag-over');
        }
        if (e.target.id === 'favorite-sidebar') {
            e.target.classList.remove('drag-over');
        }
    }
    
    function handleDropToFavorite(e) { 
        e.preventDefault();
        const droppedName = e.dataTransfer.getData('text/plain');
        
        document.querySelector('#favorite-sidebar').classList.remove('drag-over');

        const target = e.target.closest('.char-btn');
        const isFavoriteDrag = e.dataTransfer.getData('application/json') === 'favorite';
        
        if (isFavoriteDrag) {
            if (target && target.closest('#favorite-list')) {
                const sourceIndex = FAVORITE_NAMES.indexOf(droppedName);
                const targetName = target.getAttribute('data-char-name');
                const targetIndex = FAVORITE_NAMES.indexOf(targetName);
                
                if (sourceIndex !== targetIndex) {
                    const [removed] = FAVORITE_NAMES.splice(sourceIndex, 1);
                    FAVORITE_NAMES.splice(targetIndex > sourceIndex ? targetIndex : targetIndex, 0, removed);
                    localStorage.setItem('favoriteCharacters', JSON.stringify(FAVORITE_NAMES));
                }
            }
        } else {
            if (droppedName && !FAVORITE_NAMES.includes(droppedName)) {
                if (target && target.closest('#favorite-list')) {
                    const targetName = target.getAttribute('data-char-name');
                    const targetIndex = FAVORITE_NAMES.indexOf(targetName);
                    FAVORITE_NAMES.splice(targetIndex, 0, droppedName);
                } else {
                    FAVORITE_NAMES.push(droppedName);
                }
                
                localStorage.setItem('favoriteCharacters', JSON.stringify(FAVORITE_NAMES));
            }
        }
        
        render();
    }

    function handleDrop(e) { 
        e.preventDefault();
        const droppedName = e.dataTransfer.getData('text/plain');
        const isFavoriteDrag = e.dataTransfer.getData('application/json') === 'favorite';

        document.getElementById('character-selector').classList.remove('drag-over');
        document.querySelectorAll('.char-btn.drag-over').forEach(btn => btn.classList.remove('drag-over'));
        
        const target = e.target.closest('.char-btn');
        
        if (isFavoriteDrag) {
            if (FAVORITE_NAMES.includes(droppedName)) {
                removeFavorite(droppedName);
            }
        } else if (target) {
            const sourceIndex = CHARACTER_NAMES.indexOf(droppedName);
            const targetName = target.getAttribute('data-char-name');
            const targetIndex = CHARACTER_NAMES.indexOf(targetName);

            if (sourceIndex !== targetIndex) {
                const [removed] = CHARACTER_NAMES.splice(sourceIndex, 1);
                CHARACTER_NAMES.splice(targetIndex > sourceIndex ? targetIndex : targetIndex, 0, removed);
                localStorage.setItem('characterOrder', JSON.stringify(CHARACTER_NAMES));
            }
        }
        
        render();
    }

    function handleDragEnd(e) { 
        e.target.classList.remove('dragging');
        draggedElement = null;
        document.querySelectorAll('.char-btn.drag-over').forEach(btn => btn.classList.remove('drag-over'));
        document.querySelector('#favorite-sidebar').classList.remove('drag-over');
        document.querySelector('#character-selector').classList.remove('drag-over');
    }
    
    function removeFavorite(charName) { 
        FAVORITE_NAMES = FAVORITE_NAMES.filter(name => name !== charName);
        localStorage.setItem('favoriteCharacters', JSON.stringify(FAVORITE_NAMES));
        render();
    }

    function selectCharacter(id) {
        currentChrId = id;
        localStorage.setItem('currentChrId', id);
        render(); 
    }

    function toggleTask(chrId, type, taskId, shared) { 
        const item = DUNGEON_DATA[type].find(d => d.id === taskId);
        
        if (shared) {
            const status = getAccountSharedTaskStatus(taskId);
            const newCount = status.completed === 0 ? item.max : 0; 
            setAccountSharedTaskStatus(taskId, { completed: newCount, max: item.max });
        } else {
            const charIndex = characters.findIndex(c => c.id === chrId);
            if (charIndex === -1) return;
    
            const char = characters[charIndex];
            const currentCount = char[`${type}Tasks`][taskId].completed;
            
            const newCount = currentCount === 0 ? item.max : 0;
            
            char[`${type}Tasks`][taskId].completed = newCount;
            localStorage.setItem('gc_characters', JSON.stringify(characters));
        }
        
        // í†µê³„ ê°±ì‹  ë° ë Œë”ë§ì„ ìœ„í•´ render() í˜¸ì¶œ
        const char = characters.find(c => c.id === chrId);
        if (char) {
            char.dailyStats = calculateCharStats(char, 'daily');
            char.weeklyStats = calculateCharStats(char, 'weekly');
            char.hasIncompleteDaily = char.dailyStats.totalCount > char.dailyStats.completedCount;
            char.hasIncompleteWeekly = char.weeklyStats.totalCount > char.weeklyStats.completedCount;
        }


        render();
    }
    
    // === 6. ì‹œê°„ ë° í…Œë§ˆ ë¡œì§ ===
    function updateCurrentTime() { 
        const now = new Date();
        const rawString = now.toLocaleString("ko-KR", { 
            timeZone: "Asia/Seoul", 
            year: 'numeric', 
            month: '2-digit', 
            day: '2-digit', 
            weekday: 'short', 
            hour: '2-digit', 
            minute: '2-digit', 
            hour12: false 
        });
        
        let finalFormattedTime = rawString.replace(/^(\d{4})\.\s(\d{2})\.\s/, (match, year, month) => {
            return `${year}.${month}. `;
        });
        
        document.getElementById('current-time-display').innerText = finalFormattedTime;
    }

    const getTheme = () => localStorage.getItem('theme') || 'dark';

    function setTheme(theme) { 
        document.body.className = theme === 'dark' ? 'dark-mode' : 'light-mode';
        localStorage.setItem('theme', theme);
        updateThemeToggleText(theme);
    }
    
    function toggleTheme() { 
        const currentTheme = getTheme();
        setTheme(currentTheme === 'dark' ? 'light' : 'dark');
    }

    function updateThemeToggleText(theme) {
        const button = document.getElementById('theme-toggle');
        button.innerText = theme === 'dark' ? 'â˜€ï¸ ë‚® ëª¨ë“œ' : 'ğŸŒ™ ë°¤ ëª¨ë“œ';
    }

    // === 7. í™”ë©´ ë Œë”ë§ ===

    function createCharButton(charName, isFavorite = false) {
        const char = characters.find(c => c.name === charName);
        if (!char) return null;
        
        const charColor = CHAR_COLORS[char.name] || '#808080'; 
        const charTextColor = getTextColor(charColor);
        // í†µê³„ ë°ì´í„°ê°€ char ê°ì²´ì— ì´ë¯¸ ê³„ì‚°ë˜ì–´ ìˆë‹¤ê³  ê°€ì •
        // NaN ë°©ì§€ ì²˜ë¦¬
        const dailyPer = char.dailyStats.percentage || 0;
        const weeklyPer = char.weeklyStats.percentage || 0;
        const overallPercent = dailyPer * 0.5 + weeklyPer * 0.5; 

        const button = document.createElement('button');
        button.className = `char-btn ${char.id == currentChrId ? 'active' : ''}`;
        button.setAttribute('data-char-name', char.name);
        button.onclick = () => selectCharacter(char.id);

        // í…ìŠ¤íŠ¸ì™€ í”„ë¡œê·¸ë ˆìŠ¤ ë°”ë¥¼ í¬í•¨í•˜ëŠ” êµ¬ì¡° ìƒì„±
        button.innerHTML = `
            <span>${char.name}</span>
            <div class="progress-bar-container">
                <div class="progress-bar" style="width: ${overallPercent}%;"></div>
            </div>
        `;
        
        if (char.id == currentChrId) {
            button.style.backgroundColor = charColor;
            button.style.color = charTextColor;
            button.style.fontWeight = 'bold';
            button.style.boxShadow = `0 2px 5px var(--shadow-color)`;
            button.onmouseover = null;
            button.onmouseout = null;
        } else {
             // ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ê³ ìœ  ìƒ‰ìƒ ì ìš©
            button.onmouseover = function() {
                this.style.backgroundColor = charColor;
                this.style.color = charTextColor;
                this.style.opacity = 0.8;
            };
            button.onmouseout = function() {
                this.style.backgroundColor = 'var(--bg-item)';
                this.style.color = 'var(--text-color)';
                this.style.opacity = 1;
            };
        }

        if (isFavorite) {
            button.title = "ë”ë¸” í´ë¦­ ë˜ëŠ” ë“œë˜ê·¸í•˜ì—¬ ì œê±°, ë“œë˜ê·¸ ì•¤ ë“œë¡­ìœ¼ë¡œ ìˆœì„œ ë³€ê²½";
            button.ondblclick = (e) => { 
                e.preventDefault();
                removeFavorite(char.name);
            };
        }

        button.setAttribute('draggable', true);
        button.addEventListener('dragstart', handleDragStart);
        button.addEventListener('dragover', handleDragOver);
        button.addEventListener('dragleave', handleDragLeave);
        button.addEventListener('dragend', handleDragEnd);

        return button;
    }


    function renderCharacterSelector() {
        const allSelector = document.getElementById('character-selector');
        const favList = document.getElementById('favorite-list');
        
        allSelector.innerHTML = '';
        favList.innerHTML = '';

        // 1. ì¦ê²¨ì°¾ê¸° ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ (ì‚¬ì´ë“œë°”)
        const renderedFavorites = FAVORITE_NAMES.map(name => createCharButton(name, true)).filter(Boolean);
        
        if (renderedFavorites.length > 0) {
            renderedFavorites.forEach(btn => favList.appendChild(btn));
        } else {
            favList.innerHTML = '<span class="favorite-list-placeholder">ìºë¦­í„°ë¥¼ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ì„¸ìš”.</span>';
        }


        // 2. ëª¨ë“  ìºë¦­í„° ë Œë”ë§ (ìƒë‹¨)
        let filteredCharacterNames = CHARACTER_NAMES;
        
        if (isFilterActive) {
            filteredCharacterNames = CHARACTER_NAMES.filter(name => {
                const char = characters.find(c => c.name === name);
                return char && (char.hasIncompleteDaily || char.hasIncompleteWeekly);
            });
        }
        
        filteredCharacterNames.forEach(name => {
            const button = createCharButton(name, false);
            if (button) {
                allSelector.appendChild(button);
            }
        });
    }

    function renderTaskList() {
        const currentCharacter = characters.find(c => c.id == currentChrId);
        
        // ìˆ™ì œ ëª©ë¡ì´ ë³´ì´ì§€ ì•ŠëŠ” ë¬¸ì œì˜ í•µì‹¬ ìˆ˜ì •: 
        if (!currentCharacter) {
            document.getElementById('current-char-name').innerText = 'ìºë¦­í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.';
            document.getElementById('task-view-container').style.display = 'none';
            document.getElementById('daily-stats-display').innerHTML = ''; // ì•ˆì „í•˜ê²Œ ì´ˆê¸°í™”
            document.getElementById('weekly-stats-display').innerHTML = ''; // ì•ˆì „í•˜ê²Œ ì´ˆê¸°í™”
            return;
        }
        
        document.getElementById('task-view-container').style.display = 'flex';
        document.getElementById('current-char-name').innerText = `í˜„ì¬ ì„ íƒ ìºë¦­í„°: [${currentCharacter.name}]`;
        
        // === ìºë¦­í„°ë³„ í†µê³„ ë¶„ë¦¬ í‘œì‹œ ===
        
        const dailyStatsHtml = `
            <div class="stat-item">
                <span>ì¼ì¼ ì™„ë£Œìœ¨: <b>${currentCharacter.dailyStats.completedCount}/${currentCharacter.dailyStats.totalCount} (${currentCharacter.dailyStats.percentage}%)</b></span>
                <div class="stat-bar-container"><div class="stat-bar" style="width: ${currentCharacter.dailyStats.percentage}%;"></div></div>
            </div>
        `;
        const weeklyStatsHtml = `
            <div class="stat-item">
                <span>ì£¼ê°„ ì™„ë£Œìœ¨: <b>${currentCharacter.weeklyStats.completedCount}/${currentCharacter.weeklyStats.totalCount} (${currentCharacter.weeklyStats.percentage}%)</b></span>
                <div class="stat-bar-container"><div class="stat-bar" style="width: ${currentCharacter.weeklyStats.percentage}%;"></div></div>
            </div>
        `;
        
        document.getElementById('daily-stats-display').innerHTML = dailyStatsHtml;
        document.getElementById('weekly-stats-display').innerHTML = weeklyStatsHtml;

        // === ìˆ™ì œ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ ===
        const renderList = (type, listId) => {
            const container = document.getElementById(listId);
            container.innerHTML = '';
            
            const listToRender = DUNGEON_DATA[type];
            
            listToRender.forEach(item => {
                const isShared = item.shared || false;
                let taskStatus;
                
                if (isShared) {
                    taskStatus = getAccountSharedTaskStatus(item.id);
                } else {
                    // ì•ˆì „í•œ ì ‘ê·¼ì„ ìœ„í•´ í˜„ì¬ ìºë¦­í„°ì˜ íƒœìŠ¤í¬ì— ì ‘ê·¼
                    taskStatus = currentCharacter[`${type}Tasks`][item.id] || { completed: 0, max: item.max };
                }

                const isCompleted = taskStatus.completed >= taskStatus.max;
                
                const div = document.createElement('div');
                div.onclick = () => toggleTask(currentCharacter.id, type, item.id, isShared);
                div.className = `task-item ${isCompleted ? 'done' : ''}`;

                // ì²´í¬ë°•ìŠ¤
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = isCompleted;
                checkbox.onclick = (e) => {
                    e.stopPropagation(); 
                    toggleTask(currentCharacter.id, type, item.id, isShared);
                };
                
                const labelGroup = document.createElement('div');
                labelGroup.className = 'task-label-group';
                
                const label = document.createElement('span');
                label.className = 'task-label';
                label.innerText = item.name;
                labelGroup.appendChild(label);
                
                // ê³„ì • ê³µìœ  ìŠ¤í‹°ì»¤ ì¶”ê°€
                if (isShared) { 
                    const tag = document.createElement('span');
                    tag.className = 'task-tag shared'; 
                    tag.innerText = 'ê³„ì • ê³µìœ ';
                    labelGroup.appendChild(tag);
                }
                
                // ìš”ì¼ ìŠ¤í‹°ì»¤ ì¶”ê°€ (ì£¼ê°„ ìˆ™ì œì—ë§Œ ì ìš©)
                if (type === 'weekly' && item.sub) {
                    const tag = document.createElement('span');
                    tag.className = 'task-tag day'; 
                    tag.innerText = item.sub; 
                    labelGroup.appendChild(tag);
                }

                div.appendChild(checkbox);
                div.appendChild(labelGroup);

                container.appendChild(div);
            });
        };

        renderList('daily', 'daily-list');
        renderList('weekly', 'weekly-list');
    }
    
    function render() {
        initializeData();
        renderCharacterSelector(); // ìºë¦­í„° ì„ íƒ ë²„íŠ¼ ë Œë”ë§
        renderTaskList(); // ìˆ™ì œ ëª©ë¡ ë° í†µê³„ ë Œë”ë§
        updateAccountStats(); // ê³„ì • ì „ì²´ í†µê³„ ê°±ì‹ 
        updateFilterButton(); // í•„í„° ë²„íŠ¼ ìƒíƒœ ê°±ì‹ 
        updateCurrentTime(); // í˜„ì¬ ì‹œê°„ ê°±ì‹ 
    }

    // === 8. ì‹œì‘ ë° ì£¼ê¸°ì  ì²´í¬ ===
    
    setTheme(getTheme()); 
    render(); // ì´ˆê¸° ë Œë”ë§ì„ render() í•¨ìˆ˜ í•˜ë‚˜ë¡œ í†µí•©í•˜ì—¬ ìˆœì„œ ë¬¸ì œ ë°©ì§€
    
    // 1ë¶„ë§ˆë‹¤ ì „ì²´ ì´ˆê¸°í™” ì²´í¬ ë° UI ê°±ì‹  (initializeData í˜¸ì¶œ)
    setInterval(render, 60000); 
    // 1ì´ˆë§ˆë‹¤ í˜„ì¬ ì‹œê°„ ì—…ë°ì´íŠ¸
    setInterval(updateCurrentTime, 1000); 

</script>

</body>
</html>
